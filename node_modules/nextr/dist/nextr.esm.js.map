{"version":3,"file":"nextr.esm.js","sources":["../src/utils.ts","../src/Co.ts"],"sourcesContent":["export const isFunction = (fn: any): boolean => typeof fn === 'function';\n","import { isFunction } from './utils';\nimport { Fn } from './types';\n\nconst isCoError = (error: Error) => {\n  return /Co Exception/.test(error.message);\n};\n\nconst buildCoError = (fn: Function, error: Error) => {\n  const message = error.message;\n  const functionName = fn.name || String(fn).slice(0, 10);\n  const coErrorMessage = `[Co Exception ${functionName}]: ${message}`;\n  error.message = coErrorMessage;\n  return error;\n};\n\nclass Runner {\n  public fn: Function;\n  public ancestor: null | Runner;\n  public prevSibling: null | Runner;\n  public nextSibling: null | Runner;\n\n  public onError: undefined | Function;\n  public onSuccess: undefined | Function;\n  public onFinish: undefined | Function;\n\n  constructor({\n    fn,\n    ancestor,\n    onError,\n    onSuccess,\n    onFinish,\n  }: {\n    fn: Function;\n    ancestor: null | Runner;\n    onError?: Function;\n    onSuccess?: Function;\n    onFinish?: Function;\n  }) {\n    this.prevSibling = null;\n    this.nextSibling = null;\n    this.fn = fn;\n    this.ancestor = ancestor;\n\n    this.onError = onError;\n    this.onSuccess = onSuccess;\n    this.onFinish = onFinish;\n  }\n\n  run(options: any[]): void {\n    const len = this.fn.length;\n    let args = options.concat({\n      abort: () => {\n        if (isFunction(this.onError)) (this.onError as Function)();\n        if (isFunction(this.onFinish)) (this.onFinish as Function)();\n      },\n      back: () => {\n        if (this.prevSibling) this.prevSibling.run(options);\n      },\n      resume: () => {\n        if (this.prevSibling) this.prevSibling.upstream(options);\n      },\n      next: () => {\n        if (this.nextSibling) {\n          this.nextSibling.run(options);\n          return;\n        }\n\n        if (isFunction(this.onSuccess)) (this.onSuccess as Function)();\n        if (isFunction(this.onFinish)) (this.onFinish as Function)();\n      },\n    });\n\n    // If runner is in the middle, the last one should be `actions`,\n    // so args is truncate from end..\n    if (this.nextSibling) {\n      args = args.slice(-len);\n    } else {\n      // if len is 1, arg will be context value.\n      if (len === 1) args = args.slice(-2, -1);\n    }\n\n    try {\n      this.fn.apply(this, args);\n    } catch (err) {\n      // console.log('err ', isCoError(err as Error), err)\n      if (isCoError(err as Error)) {\n        throw err;\n      }\n      throw buildCoError(this.fn, err as Error);\n    }\n  }\n\n  setPrevSibling(runner: Runner) {\n    this.prevSibling = runner;\n  }\n\n  setNextSibling(runner: Runner) {\n    this.nextSibling = runner;\n  }\n\n  upstream(options: any[]): void {\n    if (this.prevSibling) this.prevSibling.upstream(options);\n    else this.run(options);\n  }\n}\n\nclass Co {\n  public current: null | Runner;\n  public ancestor: null | Runner;\n  public ctx: object | Function;\n\n  constructor(options?: { ctx: object }) {\n    this.current = null;\n    this.ancestor = null;\n    this.ctx = options ? options.ctx : {};\n  }\n\n  useFn(fn: Function, ancestor: null | Runner) {\n    const runner = new Runner({ fn, ancestor });\n    if (!this.ancestor) {\n      this.ancestor = runner;\n    }\n\n    if (this.current) {\n      this.current.setNextSibling(runner);\n      runner.setPrevSibling(this.current);\n    }\n\n    this.current = runner;\n  }\n\n  // private useOne<T1>(\n  //   fn: (arg1: T1, ctx: object, actions: actions) => void\n  // ): void;\n  // private useOne<T1, T2>(\n  //   fn: (arg1: T1, arg2: T2, ctx: object, actions: actions) => void\n  // ): void;\n  // private useOne<T1, T2, T3>(\n  //   fn: (arg1: T1, arg2: T2, arg3: T3, ctx: object, actions: actions) => void\n  // ): void;\n  // private useOne<T1, T2, T3, T4>(\n  //   fn: (\n  //     arg1: T1,\n  //     arg2: T2,\n  //     arg3: T3,\n  //     arg4: T4,\n  //     ctx: object,\n  //     actions: actions\n  //   ) => void\n  // ): void;\n  /**\n   *\n   * @param fn copy middleware function if fn is a co object.\n   */\n  private useOne(fn: Fn | Co): void {\n    if (fn instanceof Co) {\n      let runner = fn.ancestor;\n      while (runner) {\n        this.useFn(runner.fn, this.ancestor);\n        runner = runner.nextSibling;\n      }\n    } else if (typeof fn === 'function') {\n      this.useFn(fn, this.ancestor);\n    }\n  }\n\n  /**\n   *\n   * @param args could be array of function or Co object. When arg is a Co object,\n   * its middleware functions will be copied to new Co object.\n   */\n  public use(...args: (Fn | Co)[]): Co {\n    args.forEach(fn => this.useOne(fn));\n    return this;\n  }\n\n  public start(...args: any[]): object {\n    let contextArg = this.ctx;\n    if (typeof contextArg === 'function')\n      contextArg = (this.ctx as Function).call(null);\n\n    if (this.ancestor) this.ancestor.run(args.concat(contextArg));\n    return contextArg;\n  }\n}\n\nexport default Co;\n"],"names":["isFunction","fn","isCoError","error","test","message","buildCoError","functionName","name","String","slice","coErrorMessage","Runner","ancestor","onError","onSuccess","onFinish","prevSibling","nextSibling","run","options","len","length","args","concat","abort","back","resume","upstream","next","apply","err","setPrevSibling","runner","setNextSibling","Co","current","ctx","useFn","useOne","use","forEach","start","contextArg","call"],"mappings":"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"}